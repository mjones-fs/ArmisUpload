<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finite State - File Upload</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";        background: #5B6670;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        margin: 0;
        padding: 0;
      }
      
      .header {
        padding: 20px 40px;
        background: #f5f5f5;
        display: flex;
        align-items: center;
        gap: 20px;
      }
      
      .logo-img {
        height: 60px;
        width: auto;
        max-width: 100%;
        align-self: center;
        object-fit: contain;
      }
      
      .main-wrapper {
        display: flex;
        flex: 1;
        overflow: hidden;
      }
      
      .left-section {
        flex: 2;
        background: #f9f9f9;
        padding: 60px 40px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
      }
      
      .left-section h2 {
        color: #1E3A5F;
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 30px;
      }
      
      .left-section p {
        color: #555;
        line-height: 1.5;
        font-size: 1rem;
        text-align: justify;
        color: #212529;
      }
      
      .right-section {
        flex: 3;
        background: #3A3B40;
        padding: 60px 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .container {
        background: white;
        padding: 50px;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 100%;
      }
      
      h2 {
        color: #FF6B35;
        margin-bottom: 30px;
        text-align: center;
        font-size: 32px;
        font-weight: 700;
      }
      
      .customer-name {
        color: #1E3A5F;
        text-align: center;
        margin-bottom: 30px;
        font-size: 18px;
        font-weight: 600;
      }
      
      form {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      
      .form-group {
        position: relative;
        margin-bottom: 8px;
      }
      
      label {
        position: absolute;
        left: 16px;
        top: 16px;
        color: #6b7280;
        font-size: 15px;
        font-weight: 400;
        transition: all 0.3s ease;
        pointer-events: none;
        background: transparent;
        padding: 0 4px;
      }
      
      input[type="text"],
      input[type="email"] {
        width: 100%;
        padding: 16px;
        border: 1px solid #D1D5DB;
        border-radius: 8px;
        font-size: 15px;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        background: #F9FAFB;
      }
      
      input[type="text"]:focus,
      input[type="email"]:focus {
        outline: none;
        border-color: #FF6B35;
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        background: white;
      }
      
      input[type="text"]:focus + label,
      input[type="email"]:focus + label,
      input[type="text"]:not(:placeholder-shown) + label,
      input[type="email"]:not(:placeholder-shown) + label,
      input[type="text"].has-value + label,
      input[type="email"].has-value + label {
        top: -8px;
        left: 12px;
        font-size: 12px;
        color: #FF6B35;
        font-weight: 600;
        background: white;
      }
      
      input[type="text"]:read-only {
        background-color: #F3F4F6;
        cursor: not-allowed;
      }
      
      input[type="text"]:read-only + label {
        color: #6b7280;
      }
      
      .file-upload-area {
        border: 2px dashed #D1D5DB;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #F9FAFB;
      }
      
      .file-upload-area:hover,
      .file-upload-area.drag-over {
        border-color: #FF6B35;
        background: #fff;
      }
      
      .file-upload-icon {
        width: 48px;
        height: 48px;
        margin-bottom: 12px;
        fill: #1E3A5F;
      }
      
      .file-upload-text {
        color: #1E3A5F;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
      }
      
      .file-upload-subtext {
        color: #6b7280;
        font-size: 12px;
      }
      
      .file-name {
        color: #FF6B35;
        font-weight: 600;
        margin-top: 10px;
        font-size: 13px;
      }
      
      input[type="file"] {
        display: none;
      }
      
      button {
        background: #FF6B35;
        color: white;
        padding: 16px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.1s ease;
        text-transform: none;
      }
      
      button:hover {
        background: #FF5520;
        transform: translateY(-1px);
      }
      
      button:active {
        transform: translateY(0);
      }
      
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      
      .message {
        margin-top: 20px;
        padding: 12px;
        border-radius: 5px;
        text-align: center;
        font-size: 14px;
        display: none;
      }
      
      .message.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        display: block;
      }
      
      .message.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        display: block;
      }
      
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }
      
      .modal.active {
        display: flex;
      }
      
      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        min-width: 400px;
        max-width: 500px;
      }
      
      .modal-title {
        color: #333;
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        text-align: center;
      }
      
      .modal-progress {
        margin: 20px 0;
      }
      
      .progress-bar {
        width: 100%;
        height: 30px;
        background-color: #e0e0e0;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
      }
      
      .progress-fill {
        height: 100%;
        background: #FF6B35;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
      }
      
      .progress-text {
        margin-top: 10px;
        text-align: center;
        color: #666;
        font-size: 14px;
      }
      
      .cancel-btn {
        background: #dc3545;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        margin-top: 20px;
        transition: background 0.2s ease;
      }
      
      .cancel-btn:hover {
        background: #c82333;
        transform: none;
        box-shadow: none;
      }
    </style>
  </head>
  <body>    
    <div class="main-wrapper">
      <div class="left-section">
        <img src="fs-logo.webp" alt="Finite State Logo" class="logo-img">
        <h2>Finite State Binary & SBOM Analysis</h2>
        <p>Uncover vulnerabilities and risks in your firmware and devices deployed on your network.</p>
        <p>Simply upload the firmware or SBOM file and we'll take care of the rest. Our advanced scanning technology will detect the open source libraries and the associated licenses and vulnerabilities in these libraries.</p>
        <p>Our reachability analysis will then identify if these vulnerabilities are present in your software, and provide you with the evidence you need in order to remediate.</p>
        <p>If the vulnerabilities cannot be reached, then you can ignore them and focus on the ones that can be exploited.</p>
        <p>To find out more about Finite State, please visit <a href="https://finitestate.io" target="_blank">https://finitestate.io</a></p>
      </div>
      
      <div class="right-section">
        <div class="container">
      <h2>Upload Your File</h2>
      <div class="customer-name" id="customerName"></div>
      <form action="/upload" method="post" enctype="multipart/form-data">
        <div class="form-group">
          <input type="text" id="name" name="name" placeholder="&nbsp;" required />
          <label for="name">Name</label>
        </div>
        <div class="form-group">
          <input type="email" id="email" name="email" placeholder="&nbsp;" required />
          <label for="email">Email Address</label>
        </div>
        <div class="form-group">
          <input type="text" id="deviceId" name="deviceId" placeholder="&nbsp;" required />
          <label for="deviceId">Device ID</label>
        </div>
        <div class="form-group">
          <input type="text" id="version" name="version" placeholder="&nbsp;" />
          <label for="version">Version</label>
        </div>
        <div class="form-group">
          <label for="file">Select or Drop File</label>
          <div id="dropArea" class="file-upload-area" tabindex="0" role="button" aria-label="Upload file">
            <img src="upload.png" alt="Upload" class="file-upload-icon" />
            <div class="file-upload-text">Drag and drop or browse for a binary or SBOM file</div>
            <p id="fileName" class="file-name" aria-live="polite"></p>
            <input type="file" id="file" name="file" required />
          </div>
        </div>
        <button type="submit" id="uploadBtn">Upload</button>
      </form>
      <div class="message" id="message"></div>
        </div>
      </div>
    </div>
    
    <!-- Upload Modal -->
    <div class="modal" id="uploadModal">
      <div class="modal-content">
        <div class="modal-title">Uploading</div>
        <div class="modal-progress">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill">0%</div>
          </div>
          <div class="progress-text" id="progressText">Uploading...</div>
        </div>
        <button class="cancel-btn" id="cancelBtn">Cancel</button>
      </div>
    </div>
    
    <script>
      // Floating label helper function
      function updateFloatingLabel(input) {
        if (input.value && input.value.trim() !== '') {
          input.classList.add('has-value');
        } else {
          input.classList.remove('has-value');
        }
      }
      
      // Initialize floating labels on page load
      document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('input[type="text"], input[type="email"]');
        inputs.forEach(input => {
          updateFloatingLabel(input);
          input.addEventListener('input', () => updateFloatingLabel(input));
          input.addEventListener('change', () => updateFloatingLabel(input));
        });
      });
      
      // Security: Sanitize input to prevent XSS
      function sanitizeInput(input) {
        if (!input || typeof input !== 'string') {
          return '';
        }
        // Remove any HTML tags and limit length
        const div = document.createElement('div');
        div.textContent = input.substring(0, 255);
        return div.textContent || '';
      }
      
      // Security: Validate device ID format
      function validateDeviceId(deviceId) {
        if (!deviceId || typeof deviceId !== 'string') {
          return false;
        }
        // Only allow alphanumeric, hyphens, underscores, and dots
        return /^[a-zA-Z0-9._-]+$/.test(deviceId) && deviceId.length <= 255;
      }
      
      // Security: Validate email format
      function validateEmail(email) {
        if (!email || typeof email !== 'string') {
          return false;
        }
        // RFC 5322 compliant email regex (simplified)
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email) && email.length <= 255;
      }
      
      // Parse URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const rawCustomer = urlParams.get('CUSTOMER');
      const rawDevice = urlParams.get('DEVICE');
      
      // Security: Sanitize customer name
      const customer = sanitizeInput(rawCustomer);
      if (customer) {
        document.getElementById('customerName').textContent = customer;
      }
      
      // Security: Validate and sanitize device ID
      const deviceInput = document.getElementById('deviceId');
      if (rawDevice) {
        const device = sanitizeInput(rawDevice);
        if (validateDeviceId(device)) {
          deviceInput.value = device;
          deviceInput.readOnly = true;
          updateFloatingLabel(deviceInput);
        } else {
          console.warn('Invalid device ID format in URL parameter');
        }
      }
      
// Handle form submission with progress tracking
      const form = document.querySelector('form');
      const uploadBtn = document.getElementById('uploadBtn');
      const uploadModal = document.getElementById('uploadModal');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const messageDiv = document.getElementById('message');
      const cancelBtn = document.getElementById('cancelBtn');
      
      let currentXhr = null;
      
      // Drag & drop and manual file selection
      const fileInput = document.getElementById('file');
      const dropArea = document.getElementById('dropArea');
      const fileNameEl = document.getElementById('fileName');
      
      function extractVersionFromFilename(filename) {
        // Remove file extension for matching (handle double extensions like .tar.gz)
        let nameWithoutExt = filename;
        // Common double extensions
        const doubleExtensions = ['.tar.gz', '.tar.bz2', '.tar.xz', '.tar.Z'];
        for (const ext of doubleExtensions) {
          if (nameWithoutExt.endsWith(ext)) {
            nameWithoutExt = nameWithoutExt.slice(0, -ext.length);
            break;
          }
        }
        // If no double extension matched, remove single extension
        if (nameWithoutExt === filename) {
          nameWithoutExt = nameWithoutExt.replace(/\.[^.]+$/, '');
        }
        
        // Common version patterns (ordered by specificity):
        const patterns = [
          /[vV](\d+\.\d+\.\d+(?:\.\d+)?)/,  // v1.2.3 or V1.2.3.4
          /[vV](\d+[._]\d+[._]\d+(?:[._]\d+)?)/,  // v1_2_3
          /version[_-]?(\d+(?:[._]\d+)*)/i,  // version-1.2.3 or version_123
          /fw[_-]?(\d+(?:[._]\d+)*)/i,  // fw-1.2.3 or fw_123
          /rel[_-]?(\d+(?:[._]\d+)*)/i,  // rel-1.2.3 or rel_123
          /-(latest|stable|beta|alpha|dev|prod|production|staging|canary|nightly)$/i,  // -latest, -stable, etc.
          /_(latest|stable|beta|alpha|dev|prod|production|staging|canary|nightly)$/i,  // _latest, _stable, etc.
          /-(x86_64|x86|x64|amd64|arm64|armv7|armv8|aarch64|i386|i686|mips|mipsel|ppc|ppc64)$/i,  // -x86, -arm64, etc.
          /_(x86_64|x86|x64|amd64|arm64|armv7|armv8|aarch64|i386|i686|mips|mipsel|ppc|ppc64)$/i,  // _x86, _arm64, etc.
          /(\d+\.\d+\.\d+(?:\.\d+)?)/,  // 1.2.3 or 1.2.3.4
          /_(\d{6,})$/,  // _202510310 (6+ digits at end after underscore)
          /-(\d{6,})$/,  // -202510310 (6+ digits at end after hyphen)
          /_(\d+)$/,  // _123 (any digits at end after underscore)
          /-(\d+)$/   // -123 (any digits at end after hyphen)
        ];
        
        for (const pattern of patterns) {
          const match = nameWithoutExt.match(pattern);
          if (match && match[1]) {
            // Normalize underscores to dots for dotted versions, keep text as-is
            const version = match[1].replace(/_/g, '.');
            return version;
          }
        }
        
        return '';
      }
      
      function setFiles(files) {
        if (!files || files.length === 0) return;
        const dt = new DataTransfer();
        dt.items.add(files[0]);
        fileInput.files = dt.files;
        // Security: Limit filename display length to prevent UI issues
        const fileName = files[0].name;
        const maxDisplayLength = 60;
        const displayName = fileName.length > maxDisplayLength 
          ? fileName.substring(0, maxDisplayLength) + '...' 
          : fileName;
        fileNameEl.textContent = displayName;
        
        // Extract and populate version field (always overwrite)
        const versionInput = document.getElementById('version');
        const extractedVersion = extractVersionFromFilename(fileName);
        // Always set the value - overwrite existing if version is found, clear if not
        versionInput.value = extractedVersion;
        updateFloatingLabel(versionInput);
      }
      
      if (dropArea) {
        dropArea.addEventListener('click', () => fileInput.click());
        dropArea.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); }
        });
        dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('drag-over'); });
        dropArea.addEventListener('dragleave', () => dropArea.classList.remove('drag-over'));
        dropArea.addEventListener('drop', (e) => { e.preventDefault(); dropArea.classList.remove('drag-over'); setFiles(e.dataTransfer.files); });
      }
      
      fileInput.addEventListener('change', (e) => setFiles(e.target.files));
      
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate email format
        const emailInput = document.getElementById('email');
        if (!validateEmail(emailInput.value)) {
          messageDiv.className = 'message error';
          messageDiv.textContent = 'Please enter a valid email address.';
          return;
        }
        
        // Ensure a file is selected before submitting
        if (!fileInput.files || fileInput.files.length === 0) {
          messageDiv.className = 'message error';
          messageDiv.textContent = 'Please select a file to upload.';
          return;
        }
        
        const formData = new FormData(form);
        // Add customer parameter if available
        if (customer) {
          formData.append('customer', customer);
        }
        const xhr = new XMLHttpRequest();
        currentXhr = xhr;
        
        // Reset UI
        messageDiv.className = 'message';
        messageDiv.textContent = '';
        uploadModal.classList.add('active');
        uploadBtn.disabled = true;
        progressFill.style.width = '0%';
        progressFill.textContent = '0%';
        progressText.textContent = 'Uploading...';
        
        // Track upload progress
        xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
            const percentComplete = Math.round((e.loaded / e.total) * 100);
            progressFill.style.width = percentComplete + '%';
            progressFill.textContent = percentComplete + '%';
            
            // Show size info for large files
            const loadedMB = (e.loaded / (1024 * 1024)).toFixed(2);
            const totalMB = (e.total / (1024 * 1024)).toFixed(2);
            progressText.textContent = `Uploading... ${loadedMB} MB / ${totalMB} MB`;
          }
        });
        
        // Handle completion
        xhr.addEventListener('load', function() {
          currentXhr = null;
          uploadModal.classList.remove('active');
          
          if (xhr.status === 200) {
            try {
              const response = JSON.parse(xhr.responseText);
              messageDiv.className = 'message success';
              messageDiv.textContent = 'File uploaded successfully!';
              // Keep form populated - do not reset
              // Keep upload button disabled to prevent re-upload
            } catch (e) {
              messageDiv.className = 'message error';
              messageDiv.textContent = 'Upload failed: Invalid response from server';
              uploadBtn.disabled = false;
            }
          } else {
            try {
              const error = JSON.parse(xhr.responseText);
              messageDiv.className = 'message error';
              // Security: Use textContent to prevent XSS from error messages
              messageDiv.textContent = 'Upload failed: ' + (error.error || 'Unknown error');
            } catch (e) {
              messageDiv.className = 'message error';
              messageDiv.textContent = 'Upload failed: Server error';
            }
            uploadBtn.disabled = false;
          }
        });
        
        // Handle errors
        xhr.addEventListener('error', function() {
          currentXhr = null;
          uploadModal.classList.remove('active');
          messageDiv.className = 'message error';
          messageDiv.textContent = 'Upload failed: Network error';
          uploadBtn.disabled = false;
        });
        
        // Handle timeout
        xhr.addEventListener('timeout', function() {
          currentXhr = null;
          uploadModal.classList.remove('active');
          messageDiv.className = 'message error';
          messageDiv.textContent = 'Upload failed: Request timeout';
          uploadBtn.disabled = false;
        });
        
        // Handle abort (cancellation)
        xhr.addEventListener('abort', function() {
          currentXhr = null;
          uploadModal.classList.remove('active');
          messageDiv.className = 'message error';
          messageDiv.textContent = 'Upload cancelled';
          uploadBtn.disabled = false;
        });
        
        // Set a long timeout for large files (30 minutes)
        xhr.timeout = 1800000;
        
        // Send the request
        xhr.open('POST', '/upload');
        xhr.send(formData);
      });
      
      // Handle cancel button
      cancelBtn.addEventListener('click', function() {
        if (currentXhr) {
          currentXhr.abort();
        }
      });
    </script>
  </body>
</html>
