<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finite State - File Upload</title>
    <style>
      /* Font Definitions */
      @font-face {
        font-family: 'TWK Everett';
        src: url('fonts/TWKEverett-Light.woff2') format('woff2');
        font-weight: 300;
        font-style: normal;
        font-display: swap;
      }
      
      @font-face {
        font-family: 'TWK Everett';
        src: url('fonts/TWKEverett-Regular.woff2') format('woff2');
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }
      
      @font-face {
        font-family: 'TWK Everett';
        src: url('fonts/TWKEverett-Medium.woff2') format('woff2');
        font-weight: 500;
        font-style: normal;
        font-display: swap;
      }
      
      @font-face {
        font-family: 'TWK Everett';
        src: url('fonts/TWKEverett-Bold.woff2') format('woff2');
        font-weight: 700;
        font-style: normal;
        font-display: swap;
      }
      
      @font-face {
        font-family: 'Instrument Sans';
        src: url('fonts/InstrumentSans-Regular.ttf') format('truetype');
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }
      
      @font-face {
        font-family: 'Instrument Sans';
        src: url('fonts/InstrumentSans-Medium.ttf') format('truetype');
        font-weight: 500;
        font-style: normal;
        font-display: swap;
      }
      
      @font-face {
        font-family: 'Instrument Sans';
        src: url('fonts/InstrumentSans-SemiBold.ttf') format('truetype');
        font-weight: 600;
        font-style: normal;
        font-display: swap;
      }
      
      @font-face {
        font-family: 'Instrument Sans';
        src: url('fonts/InstrumentSans-Bold.ttf') format('truetype');
        font-weight: 700;
        font-style: normal;
        font-display: swap;
      }

      /* CSS Variables for Theme Colors */
      :root {
        --bg-primary: #111214;
        --bg-secondary: #111820;
        --bg-card: #151c25;
        --bg-input: #1a222d;
        --border-color: #2a3544;
        --border-focus: #38E5CE;
        --accent-primary: #00d4aa;
        --accent-primary-hover: #00e6b8;
        --accent-secondary: #f27229;
        --accent-secondary-hover: #f27229;
        --text-primary: #DCDCDC;
        --text-secondary: #A8A8A8;
        --text-muted: #6b7a8f;
        --error-bg: rgba(239, 68, 68, 0.15);
        --error-border: #ef4444;
        --error-text: #fca5a5;
        --success-bg: rgba(0, 212, 170, 0.15);
        --success-border: #00d4aa;
        --success-text: #6ee7c7;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Instrument Sans', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg-primary);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        margin: 0;
        padding: 0;
        color: var(--text-primary);
      }
      
      .logo-img {
        height: 50px;
        width: auto;
        max-width: 100%;
        align-self: center;
        object-fit: contain;
        margin-bottom: 24px;
      }
      
      .main-wrapper {
        display: flex;
        flex: 1;
        overflow: hidden;
      }
      
      .left-section {
        flex: 3;
        background: var(--bg-secondary);
        padding: 48px 40px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        border-right: 1px solid var(--border-color);
      }
      
      .left-section h2 {
        font-family: 'TWK Everett', sans-serif;
        color: var(--accent-primary);
        font-size: 28px;
        font-weight: 500;
        margin-bottom: 28px;
        letter-spacing: -0.02em;
      }
      
      .left-section p {
        color: var(--text-secondary);
        line-height: 1.7;
        font-size: 0.95rem;
        text-align: left;
        margin-bottom: 1.2em;
        font-weight: 400;
      }
      
      .left-section a {
        color: var(--accent-primary);
        text-decoration: none;
        transition: color 0.2s ease;
      }
      
      .left-section a:hover {
        color: var(--accent-primary-hover);
        text-decoration: underline;
      }
      
      .right-section {
        flex: 2;
        background: var(--bg-primary);
        padding: 48px 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .container {
        background: var(--bg-card);
        padding: 40px 44px;
        border-radius: 16px;
        border: 1px solid var(--border-color);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        max-width: 480px;
        width: 100%;
      }
      
      h2 {
        font-family: 'TWK Everett', sans-serif;
        color: var(--accent-primary);
        margin-bottom: 24px;
        text-align: center;
        font-size: 26px;
        font-weight: 500;
        letter-spacing: -0.02em;
      }
      
      .customer-name {
        color: var(--text-secondary);
        text-align: center;
        margin-bottom: 28px;
        font-size: 16px;
        font-weight: 500;
      }
      
      form {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }
      
      .form-group {
        position: relative;
        margin-bottom: 4px;
      }
      
      label {
        position: absolute;
        left: 14px;
        top: 14px;
        color: var(--text-muted);
        font-size: 14px;
        font-weight: 400;
        transition: all 0.2s ease;
        pointer-events: none;
        background: transparent;
        padding: 0 4px;
      }
      
      input[type="text"],
      input[type="email"] {
        width: 100%;
        padding: 14px 16px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 14px;
        font-family: 'Instrument Sans', sans-serif;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        background: var(--bg-input);
        color: var(--text-primary);
      }
      
      input[type="text"]:focus,
      input[type="email"]:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.15);
        background: var(--bg-input);
      }
      
      input[type="text"]:focus + label,
      input[type="email"]:focus + label,
      input[type="text"]:not(:placeholder-shown) + label,
      input[type="email"]:not(:placeholder-shown) + label,
      input[type="text"].has-value + label,
      input[type="email"].has-value + label {
        top: -8px;
        left: 12px;
        font-size: 11px;
        color: var(--accent-primary);
        font-weight: 600;
        background: var(--bg-card);
      }
      
      input[type="text"]:read-only {
        background-color: var(--bg-secondary);
        cursor: not-allowed;
        opacity: 0.7;
      }
      
      input[type="text"]:read-only + label {
        color: var(--text-muted);
      }
      
      .file-upload-area {
        border: 2px dashed var(--border-color);
        border-radius: 10px;
        padding: 28px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background: var(--bg-input);
      }
      
      .file-upload-area:hover,
      .file-upload-area.drag-over {
        border-color: var(--accent-primary);
        background: rgba(0, 212, 170, 0.05);
      }
      
      .file-upload-icon {
        width: 44px;
        height: 44px;
        margin-bottom: 12px;
      }
      
      .file-upload-text {
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 4px;
      }
      
      .file-upload-subtext {
        color: var(--text-muted);
        font-size: 12px;
      }
      
      .file-name {
        color: var(--accent-secondary);
        font-weight: 600;
        margin-top: 10px;
        font-size: 12px;
      }
      
      input[type="file"] {
        display: none;
      }
      
      button {
        font-family: 'TWK Everett', sans-serif;
        background: var(--accent-primary);
        color: var(--bg-primary);
        padding: 14px 24px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.1s ease;
        text-transform: none;
        letter-spacing: 0.01em;
      }
      
      button:hover {
        background: var(--accent-primary-hover);
        transform: translateY(-1px);
      }
      
      button:active {
        transform: translateY(0);
      }
      
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      
      .message {
        margin-top: 18px;
        padding: 12px 14px;
        border-radius: 8px;
        text-align: center;
        font-size: 13px;
        display: none;
      }
      
      .message.success {
        background-color: var(--success-bg);
        color: var(--success-text);
        border: 1px solid var(--success-border);
        display: block;
      }
      
      .message.error {
        background-color: var(--error-bg);
        color: var(--error-text);
        border: 1px solid var(--error-border);
        display: block;
      }
      
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.75);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      }
      
      .modal.active {
        display: flex;
      }
      
      .modal-content {
        background: var(--bg-card);
        padding: 28px 32px;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.5);
        min-width: 380px;
        max-width: 460px;
      }
      
      .modal-title {
        font-family: 'TWK Everett', sans-serif;
        color: var(--text-primary);
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 20px;
        text-align: center;
      }
      
      .modal-progress {
        margin: 20px 0;
      }
      
      .progress-bar {
        width: 100%;
        height: 28px;
        background-color: var(--bg-input);
        border-radius: 14px;
        overflow: hidden;
        position: relative;
        border: 1px solid var(--border-color);
      }
      
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--bg-primary);
        font-weight: 600;
        font-size: 12px;
        border-radius: 14px;
      }
      
      .progress-text {
        margin-top: 12px;
        text-align: center;
        color: var(--text-secondary);
        font-size: 13px;
      }
      
      .cancel-btn {
        background: transparent;
        color: var(--error-text);
        padding: 10px 20px;
        border: 1px solid var(--error-border);
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        margin-top: 18px;
        transition: all 0.2s ease;
        font-family: 'Instrument Sans', sans-serif;
      }
      
      .cancel-btn:hover {
        background: var(--error-bg);
        transform: none;
        box-shadow: none;
      }

      /* Scrollbar Styling */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted);
      }

      /* Responsive adjustments */
      @media (max-width: 900px) {
        .main-wrapper {
          flex-direction: column;
        }
        
        .left-section,
        .right-section {
          flex: none;
          padding: 32px 24px;
        }
        
        .left-section {
          border-right: none;
          border-bottom: 1px solid var(--border-color);
        }
        
        .container {
          padding: 28px;
        }
      }
    </style>
  </head>
  <body>    
    <div class="main-wrapper">
      <div class="left-section">
        <img src="fs-logo.png" alt="Finite State Logo" class="logo-img">
        <h2>Binary & SBOM Analysis</h2>
        <p>Finite State allows you to get immediate, actionable insight into the security of your connected devices. With a simple binary upload of your device firmware, or an upload of an existing SBOM, our system automatically generates a Software Bill of Materials (SBOM) and a Device Risk Report tailored to your environment.</p>
        <p>The SBOM shows you what's really inside your device firmware - the open source components, libraries, and versions that may introduce risk. Unlike generic SBOM tools, our analysis is performed directly on the binary itself, ensuring deep visibility into even the most opaque embedded systems. To make this information useful in your daily operations, the deliverable also includes a CSV report which correlates each software component to the actual device types in your inventory. This means that you don't just see a list of packages - you see how those packages affect the devices you rely on most.</p>
        <p>To get started, simply enter some details and click Upload. We'll take care of the rest</p>
        <p id="deviceIdDescription">The Device ID corresponds to the unique name of the device within your Armis environment. This can typically be seen on the Overview page.</p>
        <p>The Firmware of SBOM Version is used to uniquely identify the version of the firmware or SBOM file. We will attempt to discern this from the name of the file you upload, but you can enter this value if you prefer.</p>
        <p>Once uploaded, our analysis will identify the open source libraries which make up the file, as the CVE's associated with these libraries, and whether those vulnerabilities are actually reachable and exploitable.</p>
        <p>We will then follow up with you on the email address entered in order to provide you with a free report detailing our findings.</p>
        <p>To find out more about Finite State, please visit <a href="https://finitestate.io" target="_blank">https://finitestate.io</a></p>
      </div>
      
      <div class="right-section">
        <div class="container">
      <h2>Upload Your File</h2>
      <div class="customer-name" id="customerName"></div>
      <form action="/upload" method="post" enctype="multipart/form-data">
        <div class="form-group">
          <input type="text" id="name" name="name" placeholder="&nbsp;" required />
          <label for="name">Name</label>
        </div>
        <div class="form-group">
          <input type="email" id="email" name="email" placeholder="&nbsp;" required />
          <label for="email">Email Address</label>
        </div>
        <div class="form-group" id="deviceIdGroup">
          <input type="text" id="deviceId" name="deviceId" placeholder="&nbsp;" required />
          <label for="deviceId">Device ID</label>
        </div>
        <div class="form-group">
          <input type="text" id="version" name="version" placeholder="&nbsp;" />
          <label for="version">Firmware / SBOM Version</label>
        </div>
        <div class="form-group">
          <label for="file">Select or Drop File</label>
          <div id="dropArea" class="file-upload-area" tabindex="0" role="button" aria-label="Upload file">
            <img src="upload.png" alt="Upload" class="file-upload-icon" />
            <div class="file-upload-text">Drag and drop or browse for a binary or SBOM file</div>
            <p id="fileName" class="file-name" aria-live="polite"></p>
            <input type="file" id="file" name="file" required />
          </div>
        </div>
        <button type="submit" id="uploadBtn">Upload</button>
      </form>
      <div class="message" id="message"></div>
        </div>
      </div>
    </div>
    
    <!-- Upload Modal -->
    <div class="modal" id="uploadModal">
      <div class="modal-content">
        <div class="modal-title">Uploading</div>
        <div class="modal-progress">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill">0%</div>
          </div>
          <div class="progress-text" id="progressText">Uploading...</div>
        </div>
        <button class="cancel-btn" id="cancelBtn">Cancel</button>
      </div>
    </div>
    
    <script>
      // Floating label helper function
      function updateFloatingLabel(input) {
        if (input.value && input.value.trim() !== '') {
          input.classList.add('has-value');
        } else {
          input.classList.remove('has-value');
        }
      }
      
      // Initialize floating labels on page load
      document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('input[type="text"], input[type="email"]');
        inputs.forEach(input => {
          updateFloatingLabel(input);
          input.addEventListener('input', () => updateFloatingLabel(input));
          input.addEventListener('change', () => updateFloatingLabel(input));
        });
      });
      
      // Security: Sanitize input to prevent XSS
      function sanitizeInput(input) {
        if (!input || typeof input !== 'string') {
          return '';
        }
        // Remove any HTML tags and limit length
        const div = document.createElement('div');
        div.textContent = input.substring(0, 255);
        return div.textContent || '';
      }
      
      // Security: Validate device ID format
      function validateDeviceId(deviceId) {
        if (!deviceId || typeof deviceId !== 'string') {
          return false;
        }
        // Only allow alphanumeric, hyphens, underscores, and dots
        return /^[a-zA-Z0-9._-]+$/.test(deviceId) && deviceId.length <= 255;
      }
      
      // Security: Validate email format
      function validateEmail(email) {
        if (!email || typeof email !== 'string') {
          return false;
        }
        // RFC 5322 compliant email regex (simplified)
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email) && email.length <= 255;
      }
      
      // Parse URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const rawCustomer = urlParams.get('CUSTOMER');
      const rawDevice = urlParams.get('DEVICE');
      
      // Security: Sanitize customer name
      const customer = sanitizeInput(rawCustomer);
      if (customer) {
        document.getElementById('customerName').textContent = customer;
      }
      
      // Security: Validate and sanitize device ID
      const deviceInput = document.getElementById('deviceId');
      const deviceIdGroup = document.getElementById('deviceIdGroup');
      const deviceIdDescription = document.getElementById('deviceIdDescription');
      if (rawDevice) {
        const device = sanitizeInput(rawDevice);
        if (validateDeviceId(device)) {
          deviceInput.value = device;
          updateFloatingLabel(deviceInput);
          // Hide the Device ID field and description when DEVICE parameter is present
          if (deviceIdGroup) {
            deviceIdGroup.style.display = 'none';
          }
          if (deviceIdDescription) {
            deviceIdDescription.style.display = 'none';
          }
        } else {
          console.warn('Invalid device ID format in URL parameter');
        }
      }
      
// Handle form submission with progress tracking
      const form = document.querySelector('form');
      const uploadBtn = document.getElementById('uploadBtn');
      const uploadModal = document.getElementById('uploadModal');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const messageDiv = document.getElementById('message');
      const cancelBtn = document.getElementById('cancelBtn');
      
      let currentXhr = null;
      
      // Drag & drop and manual file selection
      const fileInput = document.getElementById('file');
      const dropArea = document.getElementById('dropArea');
      const fileNameEl = document.getElementById('fileName');
      
      function extractVersionFromFilename(filename) {
        // Remove file extension for matching (handle double extensions like .tar.gz)
        let nameWithoutExt = filename;
        // Common double extensions
        const doubleExtensions = ['.tar.gz', '.tar.bz2', '.tar.xz', '.tar.Z'];
        for (const ext of doubleExtensions) {
          if (nameWithoutExt.endsWith(ext)) {
            nameWithoutExt = nameWithoutExt.slice(0, -ext.length);
            break;
          }
        }
        // If no double extension matched, remove single extension
        if (nameWithoutExt === filename) {
          nameWithoutExt = nameWithoutExt.replace(/\.[^.]+$/, '');
        }
        
        // Common version patterns (ordered by specificity):
        const patterns = [
          /[vV](\d+\.\d+\.\d+(?:\.\d+)?)/,  // v1.2.3 or V1.2.3.4
          /[vV](\d+[._]\d+[._]\d+(?:[._]\d+)?)/,  // v1_2_3
          /version[_-]?(\d+(?:[._]\d+)*)/i,  // version-1.2.3 or version_123
          /fw[_-]?(\d+(?:[._]\d+)*)/i,  // fw-1.2.3 or fw_123
          /rel[_-]?(\d+(?:[._]\d+)*)/i,  // rel-1.2.3 or rel_123
          /-(latest|stable|beta|alpha|dev|prod|production|staging|canary|nightly)$/i,  // -latest, -stable, etc.
          /_(latest|stable|beta|alpha|dev|prod|production|staging|canary|nightly)$/i,  // _latest, _stable, etc.
          /-(x86_64|x86|x64|amd64|arm64|armv7|armv8|aarch64|i386|i686|mips|mipsel|ppc|ppc64)$/i,  // -x86, -arm64, etc.
          /_(x86_64|x86|x64|amd64|arm64|armv7|armv8|aarch64|i386|i686|mips|mipsel|ppc|ppc64)$/i,  // _x86, _arm64, etc.
          /(\d+\.\d+\.\d+(?:\.\d+)?)/,  // 1.2.3 or 1.2.3.4
          /_(\d{6,})$/,  // _202510310 (6+ digits at end after underscore)
          /-(\d{6,})$/,  // -202510310 (6+ digits at end after hyphen)
          /_(\d+)$/,  // _123 (any digits at end after underscore)
          /-(\d+)$/   // -123 (any digits at end after hyphen)
        ];
        
        for (const pattern of patterns) {
          const match = nameWithoutExt.match(pattern);
          if (match && match[1]) {
            // Normalize underscores to dots for dotted versions, keep text as-is
            const version = match[1].replace(/_/g, '.');
            return version;
          }
        }
        
        return '';
      }
      
      function setFiles(files) {
        if (!files || files.length === 0) return;
        const dt = new DataTransfer();
        dt.items.add(files[0]);
        fileInput.files = dt.files;
        // Security: Limit filename display length to prevent UI issues
        const fileName = files[0].name;
        const maxDisplayLength = 60;
        const displayName = fileName.length > maxDisplayLength 
          ? fileName.substring(0, maxDisplayLength) + '...' 
          : fileName;
        fileNameEl.textContent = displayName;
        
        // Extract and populate version field only if empty (preserve user-entered values)
        const versionInput = document.getElementById('version');
        if (!versionInput.value.trim()) {
          const extractedVersion = extractVersionFromFilename(fileName);
          if (extractedVersion) {
            versionInput.value = extractedVersion;
            updateFloatingLabel(versionInput);
          }
        }
      }
      
      if (dropArea) {
        dropArea.addEventListener('click', () => fileInput.click());
        dropArea.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); }
        });
        dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('drag-over'); });
        dropArea.addEventListener('dragleave', () => dropArea.classList.remove('drag-over'));
        dropArea.addEventListener('drop', (e) => { e.preventDefault(); dropArea.classList.remove('drag-over'); setFiles(e.dataTransfer.files); });
      }
      
      fileInput.addEventListener('change', (e) => setFiles(e.target.files));
      
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate email format
        const emailInput = document.getElementById('email');
        if (!validateEmail(emailInput.value)) {
          messageDiv.className = 'message error';
          messageDiv.textContent = 'Please enter a valid email address.';
          return;
        }
        
        // Ensure a file is selected before submitting
        if (!fileInput.files || fileInput.files.length === 0) {
          messageDiv.className = 'message error';
          messageDiv.textContent = 'Please select a file to upload.';
          return;
        }
        
        const formData = new FormData(form);
        // Add customer parameter if available
        if (customer) {
          formData.append('customer', customer);
        }
        const xhr = new XMLHttpRequest();
        currentXhr = xhr;
        
        // Reset UI
        messageDiv.className = 'message';
        messageDiv.textContent = '';
        uploadModal.classList.add('active');
        uploadBtn.disabled = true;
        progressFill.style.width = '0%';
        progressFill.textContent = '0%';
        progressText.textContent = 'Uploading...';
        
        // Track upload progress
        xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
            const percentComplete = Math.round((e.loaded / e.total) * 100);
            progressFill.style.width = percentComplete + '%';
            progressFill.textContent = percentComplete + '%';
            
            // Show size info for large files
            const loadedMB = (e.loaded / (1024 * 1024)).toFixed(2);
            const totalMB = (e.total / (1024 * 1024)).toFixed(2);
            progressText.textContent = `Uploading... ${loadedMB} MB / ${totalMB} MB`;
          }
        });
        
        // Handle completion
        xhr.addEventListener('load', function() {
          currentXhr = null;
          uploadModal.classList.remove('active');
          
          if (xhr.status === 200) {
            try {
              const response = JSON.parse(xhr.responseText);
              messageDiv.className = 'message success';
              messageDiv.textContent = 'File uploaded successfully!';
              // Keep form populated - do not reset
              // Keep upload button disabled to prevent re-upload
            } catch (e) {
              messageDiv.className = 'message error';
              messageDiv.textContent = 'Upload failed: Invalid response from server';
              uploadBtn.disabled = false;
            }
          } else {
            try {
              const error = JSON.parse(xhr.responseText);
              messageDiv.className = 'message error';
              // Security: Use textContent to prevent XSS from error messages
              messageDiv.textContent = 'Upload failed: ' + (error.error || 'Unknown error');
            } catch (e) {
              messageDiv.className = 'message error';
              messageDiv.textContent = 'Upload failed: Server error';
            }
            uploadBtn.disabled = false;
          }
        });
        
        // Handle errors
        xhr.addEventListener('error', function() {
          currentXhr = null;
          uploadModal.classList.remove('active');
          messageDiv.className = 'message error';
          messageDiv.textContent = 'Upload failed: Network error';
          uploadBtn.disabled = false;
        });
        
        // Handle timeout
        xhr.addEventListener('timeout', function() {
          currentXhr = null;
          uploadModal.classList.remove('active');
          messageDiv.className = 'message error';
          messageDiv.textContent = 'Upload failed: Request timeout';
          uploadBtn.disabled = false;
        });
        
        // Handle abort (cancellation)
        xhr.addEventListener('abort', function() {
          currentXhr = null;
          uploadModal.classList.remove('active');
          messageDiv.className = 'message error';
          messageDiv.textContent = 'Upload cancelled';
          uploadBtn.disabled = false;
        });
        
        // Set a long timeout for large files (30 minutes)
        xhr.timeout = 1800000;
        
        // Send the request
        xhr.open('POST', '/upload');
        xhr.send(formData);
      });
      
      // Handle cancel button
      cancelBtn.addEventListener('click', function() {
        if (currentXhr) {
          currentXhr.abort();
        }
      });
    </script>
  </body>
</html>
